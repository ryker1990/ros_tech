/*! rosin-device-backend 2018-11-26 */

"use strict";var o=function(){function n(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}}(),e=require("events"),n=u(e),t=require("i2c-bus"),r=u(t),s=require("./Config"),a=u(s),i=require("child_process"),l=u(i);function u(e){return e&&e.__esModule?e:{default:e}}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function f(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function y(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var d=function(e){function t(){c(this,t);var e=f(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.address=32,e.i2c=r.default.openSync(1),e.timeout=0,e.start=e.start.bind(e),e.writeState=e.writeState.bind(e),e.readState=e.readState.bind(e),e.configure=e.configure.bind(e),e.setRelays=e.setRelays.bind(e),e.stopHeatPlates=e.stopHeatPlates.bind(e),e.startTopHeatPlate=e.startTopHeatPlate.bind(e),e.startBottomHeatPlate=e.startBottomHeatPlate.bind(e),e.stopTopHeatPlate=e.stopTopHeatPlate.bind(e),e.stopBottomHeatPlate=e.stopBottomHeatPlate.bind(e),e.closePress=e.closePress.bind(e),e.startPress=e.startPress.bind(e),e.openPress=e.openPress.bind(e),e}return y(t,n.default),o(t,[{key:"i2cDebug",value:function(){console.log("i2cDebug output");var e=l.default.execSync("i2cdetect -y 1");console.log(e.toString())}},{key:"start",value:function(){var t=this;return this.configure().then(function(){t.writeState(0)}).then(this.readState).then(function(e){return t.parseState(e)})}},{key:"configure",value:function(){var e=this;return new Promise(function(t,o){e.i2c.writeByte(e.address,0,0,function(e){e?o(e):t()})})}},{key:"writeState",value:function(e){var n=this;return new Promise(function(t,o){n.i2c.writeByte(n.address,9,e,function(e){e?(console.log("Error writing: "+e),o(e)):t()})})}},{key:"readState",value:function(){var e=this;return new Promise(function(o,n){e.i2c.readByte(e.address,9,function(e,t){e?n(e):o(t)})})}},{key:"setRelays",value:function(o,n){var t=this,r=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(0==o.count)return console.log("No relays to set"),new Promise(function(e,t){e()});var s=void 0,a=void 0;return this.readState().catch(function(e){throw console.log("Error reading state (1):"),console.log(e),t.i2cDebug(),e}).then(function(e){s=e;for(var t=0;t<o.length;t++)e^=(-n^e)&1<<o[t];return a=e,r&&(console.log("Relays updated:",o),console.log("New relays state:",n),console.log("Initial state: "),console.log(s),console.log("Updated state: "),console.log(a)),e}).then(this.writeState).then(function(){r&&console.log("Did write state")}).catch(function(e){throw console.log("Error writing state:"),console.log(e),t.i2cDebug(),e}).then(this.readState).catch(function(e){throw console.log("Error reading state:"),console.log(e),t.i2cDebug(),e}).then(function(e){if(r&&(console.log("Did read state"),console.log(e)),e!=a)throw console.log("Updated state mismatch, will throw."),console.log(e,a),"Updated state wasn't written correctly.";return t.parseState(e)}).catch(function(e){throw console.log("Error setting state:"),console.log(e),t.i2cDebug(),e})}},{key:"closePress",value:function(){var o=this;console.log("closePress");var e=a.default.closePress[a.default.pressType];return this.setRelays(e[0].relays,e[0].state).then(function(){return o.setRelays(e[1].relays,e[1].state,!0)}).then(function(){return new Promise(function(e,t){clearTimeout(o.timeout),o.timeout=setTimeout(e,a.default.travelTime[a.default.pressType])})}).then(function(){return o.setRelays(e[2].relays,e[2].state)})}},{key:"startPress",value:function(o){var n=this;return console.log("startPress"),new Promise(function(e,t){clearTimeout(n.timeout),n.timeout=setTimeout(e,o)})}},{key:"openPress",value:function(){var o=this;console.log("openPress");var e=a.default.openPress[a.default.pressType];return console.log("Settings relays",e[0].relays,e[0].state),this.setRelays(e[0].relays,e[0].state).then(function(){return console.log("Settings relays",e[1].relays,e[1].state),o.setRelays(e[1].relays,e[1].state)}).then(function(){return new Promise(function(e,t){clearTimeout(o.timeout),o.timeout=setTimeout(e,a.default.travelTime[a.default.pressType])})}).then(function(){return console.log("Settings relays",e[2].relays,e[2].state),o.setRelays(e[2].relays,e[2].state)})}},{key:"stopHeatPlates",value:function(){return this.setRelays([5,6],0)}},{key:"startTopHeatPlate",value:function(){return this.setRelays([4],1)}},{key:"startBottomHeatPlate",value:function(){return this.setRelays([5],1)}},{key:"stopTopHeatPlate",value:function(){return this.setRelays([4],0)}},{key:"stopBottomHeatPlate",value:function(){return this.setRelays([5],0)}},{key:"parseState",value:function(e){var t;t=[];for(var o=0;o<8;o++)t[o]=(e>>o)%2;return t}}]),t}();module.exports=d;
//# sourceMappingURL=../sourcemap/RelayController.js