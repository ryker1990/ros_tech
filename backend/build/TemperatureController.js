/*! rosin-device-backend 2018-11-26 */

"use strict";var e=function(){function o(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(t,e,r){return e&&o(t.prototype,e),r&&o(t,r),t}}(),t=require("events"),o=p(t),r=require("./Config"),n=p(r),a=require("i2c-bus"),u=p(a),i=require("./Constants");function p(t){return t&&t.__esModule?t:{default:t}}function l(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function m(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var f=function(t){function r(t){l(this,r);var e=s(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return e.topAddress=103,e.bottomAddress=96,e.i2c=u.default.openSync(1),e.relayController=t,e.temperatureMonitorTimeout=null,e.topTemperature=0,e.bottomTemperature=0,e.targetTopTemperature=0,e.targetBottomTemperature=0,e.readState=e.readState.bind(e),e.writeByte=e.writeByte.bind(e),e.start=e.start.bind(e),e.setTopTargetTemp=e.setTopTargetTemp.bind(e),e.setBottomTargetTemp=e.setBottomTargetTemp.bind(e),e.updateTempControl=e.updateTempControl.bind(e),e.updateTempControlStep=e.updateTempControlStep.bind(e),e.stopTempControl=e.stopTempControl.bind(e),e.configure=e.configure.bind(e),e.readTemperature=e.readTemperature.bind(e),e.topBuffer=[],e.bottomBuffer=[],e}return m(r,o.default),e(r,[{key:"start",value:function(){var t=this;return this.writeByte(this.topAddress,5,7).then(function(){return t.writeByte(t.topAddress,6,124)}).then(function(){return t.writeByte(t.bottomAddress,5,7)}).then(function(){return t.writeByte(t.bottomAddress,6,124)}).then(this.updateTempControl)}},{key:"writeByte",value:function(t,o,n){var a=this;return new Promise(function(e,r){a.i2c.writeByte(t,o,n,function(t){t?r(t):e()})})}},{key:"readState",value:function(){var e=this;return this.readTemperature(this.topAddress).then(function(t){t[0]==t[1]?console.log("Not setting top temp: Buffers equal."):e.topTemperature=e.parseData(t)}).then(this.readTemperature.bind(this,this.bottomAddress)).then(function(t){t[0]==t[1]?console.log("Not setting bottom temp: Buffers equal."):e.bottomTemperature=e.parseData(t)}).then(function(){console.log(e.topTemperature,e.bottomTemperature)}).catch(function(t){throw console.log("Error reading temp state"),console.log(t),t})}},{key:"configure",value:function(t){var o=this;return new Promise(function(e,r){o.i2c.sendByte(t,0,function(t){t?r(t):e()})})}},{key:"readTemperature",value:function(t){var n=this;return n.configure(t).then(function(){return new Promise(function(e,r){var o=new Uint8Array(2);n.i2c.readI2cBlock(t,0,2,o,function(t){t?r(t):e(o)})})}).catch(function(t){throw console.log("Error reading temperatures"),console.log(t),t})}},{key:"temperatures",value:function(){return[this.topTemperature,this.bottomTemperature]}},{key:"parseData",value:function(t){return 128==(128&t[0])?(t[0]=127&t[0],1024-(16*t[0]+t[1]/16)):16*t[0]+t[1]/16}},{key:"setTopTargetTemp",value:function(t){return this.targetTopTemperature=t,this.updateTempControl()}},{key:"setBottomTargetTemp",value:function(t){return this.targetBottomTemperature=t,this.updateTempControl()}},{key:"updateTempControl",value:function(){var o=this;return this.stopTempControl(),this.readState().then(function(){var t,e;t=o.percentage(o.topTemperature,o.targetTopTemperature),e=o.percentage(o.bottomTemperature,o.targetBottomTemperature),o.topBuffer=[],o.bottomBuffer=[];for(var r=0;r<10;r++)o.topBuffer.push(10*t<=r),o.bottomBuffer.push(10*e<=r);o.updateTempControlStep()}).catch(function(t){console.log("Error updating temp control - will try to switch off relays"),o.relayController.stopBottomHeatPlate().then(o.relayController.stopTopHeatPlate).catch(function(t){console.log("Potentially dangerous problem:\nCouldn't switch off heating plate relays")})})}},{key:"percentage",value:function(t,e){if(e<t||0==t||0==e)return 0;if(t<e-n.default.rampingTempStart)return 1;var r=void 0;return r=(t-(e-n.default.rampingTempStart))/n.default.rampingTempStart,n.default.rampingPercentStart-(n.default.rampingPercentStart-n.default.rampingPercentEnd)*r}},{key:"updateTempControlStep",value:function(){var e=this,t=void 0,r=void 0;null==this.topBuffer||null==this.bottomBuffer||this.topBuffer.length<=0||this.bottomBuffer.length<=0?this.updateTempControl():(t=this.topBuffer.pop()?this.relayController.stopTopHeatPlate:this.relayController.startTopHeatPlate,r=this.bottomBuffer.pop()?this.relayController.stopBottomHeatPlate:this.relayController.startBottomHeatPlate,(this.bottomTemperature>n.default.maxTemp||this.topTemperature>n.default.maxTemp)&&(r=this.relayController.stopBottomHeatPlate,t=this.relayController.stopTopHeatPlate),t().then(r).then(function(){clearTimeout(e.temperatureMonitorTimeout),e.temperatureMonitorTimeout=setTimeout(e.updateTempControlStep,100)}).catch(function(t){console.log("Error in adjusting temp:"),console.log(t),clearTimeout(e.temperatureMonitorTimeout),e.temperatureMonitorTimeout=setTimeout(e.updateTempControlStep,1e3)}))}},{key:"stopTempControl",value:function(){clearTimeout(this.temperatureMonitorTimeout)}}]),r}();module.exports=f;
//# sourceMappingURL=../sourcemap/TemperatureController.js